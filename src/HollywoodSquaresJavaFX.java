import java.util.concurrent.ThreadLocalRandom;

/**
 * Hollywood Squares game logic for JavaFX.
 * Uses JavaFXGameBoard for UI interactions.
 */
public final class HollywoodSquaresJavaFX {
    private static final int EMPTY_CELL = 3;
    private static final int WINNING_SCORE = 500;
    private static final int WIN_ROUND_SCORE = 250;
    private static final int TIE_MULTIPLIER = 50;
    
    private final int[][] board;
    private final Player player1;
    private final Player player2;
    private final QuestionBank questionBank;
    private final JavaFXGameBoard gameBoard;
    
    private boolean gameWon;
    private boolean roundWon;
    private int questionCounter;
    private int currentTurn;
    private String currentAnswer;

    public HollywoodSquaresJavaFX() {
        this.board = new int[3][3];
        this.gameBoard = JavaFXGameBoard.getInstance();
        
        // Initialize board
        initializeBoard();
        
        // Setup game
        var difficulty = gameBoard.askDifficulty();
        this.questionBank = new QuestionBank(difficulty);
        
        var numPlayers = gameBoard.askNumOfPlayers();
        this.player1 = createPlayer1();
        this.player2 = createPlayer2(numPlayers);
        
        gameBoard.setPlayers(player1.getName(), player2.getName());
        
        this.gameWon = false;
        this.roundWon = false;
        this.questionCounter = 0;
        this.currentTurn = 1;
        
        gameBoard.display(\"ğŸ® Welcome to Hollywood Squares - JavaFX Edition!\\n\");\n        gameBoard.display(\"âœ¨ Beautiful UI powered by JavaFX 21\\n\\n\");\n    }\n\n    private void initializeBoard() {\n        for (int i = 0; i < 3; i++) {\n            for (int j = 0; j < 3; j++) {\n                board[i][j] = EMPTY_CELL;\n            }\n        }\n    }\n\n    private Player createPlayer1() {\n        String name = null;\n        while (name == null || name.isBlank()) {\n            name = gameBoard.askInput(\"Please enter your name:\");\n        }\n        return new Player(name, 0, true);\n    }\n\n    private Player createPlayer2(int numPlayers) {\n        if (numPlayers == 1) {\n            return new Player(\"Computer ğŸ¤–\", 1, false);\n        }\n        var name = gameBoard.askInput(\"Please enter player two's name:\");\n        return new Player(name != null && !name.isBlank() ? name : \"Player 2\", 1, true);\n    }\n\n    public void play() {\n        while (!gameWon) {\n            playTurn();\n        }\n        endGame();\n    }\n\n    private void playTurn() {\n        var currentPlayer = getCurrentPlayer();\n        \n        gameBoard.display(\"%s's turn\\n\".formatted(currentPlayer.getName()));\n        gameBoard.showAlert(\"%s's turn!\".formatted(currentPlayer.getName()));\n        \n        var block = selectBlock(currentPlayer);\n        \n        if (!isBlockAvailable(block)) {\n            gameBoard.display(\"âš ï¸ This block is not available\\n\");\n            return;\n        }\n        \n        displayBlockSelection(block);\n        var question = askQuestion();\n        displayCelebAnswer(question);\n        \n        var playerDecision = getPlayerDecision(currentPlayer);\n        var isCorrect = checkAnswer(question, playerDecision);\n        \n        handleAnswer(isCorrect, currentPlayer, block);\n        \n        if (roundWon) {\n            handleRoundWin();\n        }\n        \n        switchTurn();\n    }\n\n    private Player getCurrentPlayer() {\n        return currentTurn == 1 ? player1 : player2;\n    }\n\n    private Player getOpponentPlayer() {\n        return currentTurn == 1 ? player2 : player1;\n    }\n\n    private int selectBlock(Player player) {\n        if (player.isHuman()) {\n            return gameBoard.getBlock();\n        }\n        return selectComputerBlock();\n    }\n\n    private int selectComputerBlock() {\n        // AI logic: Try to win, block opponent, or take strategic position\n        var winningBlock = findWinningBlock(player2.getMark());\n        if (winningBlock != -1) return winningBlock;\n        \n        var blockingBlock = findWinningBlock(player1.getMark());\n        if (blockingBlock != -1) return blockingBlock;\n        \n        // Take center if available\n        if (isBlockAvailable(5)) return 5;\n        \n        // Take corners or edges\n        int[] preferredBlocks = {1, 3, 7, 9, 2, 4, 6, 8};\n        for (var block : preferredBlocks) {\n            if (isBlockAvailable(block)) return block;\n        }\n        \n        return 5;\n    }\n\n    private int findWinningBlock(int mark) {\n        for (int block = 1; block <= 9; block++) {\n            if (!isBlockAvailable(block)) continue;\n            \n            var pos = Position.fromBlock(block);\n            board[pos.row()][pos.column()] = mark;\n            \n            if (checkWinningPatternAt(pos, mark)) {\n                board[pos.row()][pos.column()] = EMPTY_CELL;\n                return block;\n            }\n            \n            board[pos.row()][pos.column()] = EMPTY_CELL;\n        }\n        return -1;\n    }\n\n    private boolean isBlockAvailable(int block) {\n        var pos = Position.fromBlock(block);\n        return board[pos.row()][pos.column()] == EMPTY_CELL;\n    }\n\n    private void displayBlockSelection(int block) {\n        var celebrity = Celebrity.fromBlock(block);\n        gameBoard.display(\"Selected: %s\\n\".formatted(celebrity.getDisplayName()));\n    }\n\n    private Question askQuestion() {\n        var question = questionBank.getQuestion(questionCounter);\n        gameBoard.displayQuestion(question.question());\n        return question;\n    }\n\n    private void displayCelebAnswer(Question question) {\n        currentAnswer = questionBank.getRandomAnswer(question);\n        gameBoard.displayAnswer(currentAnswer);\n        \n        questionCounter = (questionCounter + 1) % questionBank.getQuestionCount();\n    }\n\n    private boolean getPlayerDecision(Player player) {\n        if (player.isHuman()) {\n            return gameBoard.agreeDisagree();\n        }\n        \n        // Computer random decision\n        var decision = ThreadLocalRandom.current().nextBoolean();\n        var action = decision ? \"agreed\" : \"disagreed\";\n        gameBoard.display(\"%s has %s.\\n\".formatted(player.getName(), action));\n        return decision;\n    }\n\n    private boolean checkAnswer(Question question, boolean playerAgreed) {\n        var isAnswerCorrect = questionBank.isCorrectAnswer(question, currentAnswer);\n        return (playerAgreed && isAnswerCorrect) || (!playerAgreed && !isAnswerCorrect);\n    }\n\n    private void handleAnswer(boolean isCorrect, Player currentPlayer, int block) {\n        if (isCorrect) {\n            gameBoard.display(\"âœ… Your answer is correct!\\n\");\n            markBlock(currentPlayer, block);\n        } else {\n            gameBoard.display(\"âŒ Your answer is not correct!\\n\");\n            var opponent = getOpponentPlayer();\n            \n            if (!wouldOpponentWin(opponent, block)) {\n                markBlock(opponent, block);\n            }\n        }\n    }\n\n    private boolean wouldOpponentWin(Player opponent, int block) {\n        if (opponent.getNumOfMarks() < 2) return false;\n        \n        var pos = Position.fromBlock(block);\n        board[pos.row()][pos.column()] = opponent.getMark();\n        boolean wouldWin = checkWinningPatternAt(pos, opponent.getMark());\n        board[pos.row()][pos.column()] = EMPTY_CELL;\n        \n        return wouldWin;\n    }\n\n    private void markBlock(Player player, int block) {\n        var pos = Position.fromBlock(block);\n        \n        board[pos.row()][pos.column()] = player.getMark();\n        player.incrementMarks();\n        \n        gameBoard.updateBoardAtBlock(block, player.getMark());\n        \n        checkRoundWin(pos, player);\n    }\n\n    private void checkRoundWin(Position pos, Player player) {\n        var totalMarks = player1.getNumOfMarks() + player2.getNumOfMarks();\n        \n        if (totalMarks == 9) {\n            handleTieGame();\n            return;\n        }\n        \n        if (checkWinningPatternAt(pos, player.getMark())) {\n            roundWon = true;\n            player.updateScore(WIN_ROUND_SCORE);\n            gameBoard.updateScore(player.getMark(), player.getScore());\n        }\n    }\n\n    private boolean checkWinningPatternAt(Position pos, int mark) {\n        var row = pos.row();\n        var col = pos.column();\n        \n        // Check row\n        if (board[row][0] == mark && board[row][1] == mark && board[row][2] == mark) {\n            return true;\n        }\n        \n        // Check column\n        if (board[0][col] == mark && board[1][col] == mark && board[2][col] == mark) {\n            return true;\n        }\n        \n        // Check diagonals\n        if (row == col && board[0][0] == mark && board[1][1] == mark && board[2][2] == mark) {\n            return true;\n        }\n        \n        if (row + col == 2 && board[0][2] == mark && board[1][1] == mark && board[2][0] == mark) {\n            return true;\n        }\n        \n        return false;\n    }\n\n    private void handleTieGame() {\n        var winner = player1.getNumOfMarks() > player2.getNumOfMarks() ? player1 : player2;\n        var score = winner.getNumOfMarks() * TIE_MULTIPLIER;\n        winner.updateScore(score);\n        gameBoard.updateScore(winner.getMark(), winner.getScore());\n        roundWon = true;\n    }\n\n    private void handleRoundWin() {\n        checkGameWin();\n        resetBoard();\n        gameBoard.display(\"\\nğŸ”„ New Round starting...\\n\\n\");\n        currentTurn = 2;\n    }\n\n    private void checkGameWin() {\n        if (player1.getScore() >= WINNING_SCORE || player2.getScore() >= WINNING_SCORE) {\n            gameWon = true;\n        }\n    }\n\n    private void resetBoard() {\n        if (!gameWon) {\n            initializeBoard();\n            gameBoard.cleanBoard();\n            player1.resetMarks();\n            player2.resetMarks();\n            roundWon = false;\n        }\n    }\n\n    private void switchTurn() {\n        currentTurn = currentTurn == 1 ? 2 : 1;\n    }\n\n    private void endGame() {\n        var winner = player1.getScore() > player2.getScore() ? player1 : player2;\n        var message = \"\"\"\n            \n            ğŸ‰ğŸ‰ğŸ‰ GAME OVER! ğŸ‰ğŸ‰ğŸ‰\n            \n            %s's score: %d\n            %s's score: %d\n            \n            ğŸ† The winner is %s! ğŸ†\n            \n            Thanks for playing!\n            \"\"\".formatted(\n                player1.getName(), player1.getScore(),\n                player2.getName(), player2.getScore(),\n                winner.getName()\n            );\n        \n        gameBoard.display(message);\n        gameBoard.showAlert(\"ğŸ† The winner is \" + winner.getName() + \"! ğŸ†\");\n    }\n}\n